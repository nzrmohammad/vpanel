# bot/admin_handlers/user_management/creation.py

import uuid as uuid_lib
import time
import asyncio
import logging
from telebot import types

# Ø§ÛŒÙ…Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
from bot.keyboards.admin import admin_keyboard as admin_menu
from bot.database import db
from bot.utils.formatters import escape_markdown
from bot.utils.network import _safe_edit
from bot.utils.parsers import validate_uuid
from bot.services.panels import PanelFactory
from bot.bot_instance import bot # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡: Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§Øª Ø§ØµÙ„ÛŒ

# âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡: Ø¨Ù‡ Ø¬Ø§ÛŒ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…ØªØºÛŒØ±Ù‡Ø§ØŒ Ú©Ù„ Ù…Ø§Ú˜ÙˆÙ„ state Ø±Ø§ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ú©Ù†ÛŒØ¯
from bot.admin_handlers.user_management import state 
from bot.admin_handlers.user_management.helpers import _delete_user_message, _auto_delete

logger = logging.getLogger(__name__)

# ==============================================================================
# 3. Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ (Add User Flow)
# ==============================================================================

async def handle_add_user_select_panel(call: types.CallbackQuery):
    """Ø´Ø±ÙˆØ¹ Ù¾Ø±ÙˆØ³Ù‡: Ø°Ø®ÛŒØ±Ù‡ Ù¾Ù†Ù„ Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…"""
    uid = call.from_user.id
    msg_id = call.message.message_id
    
    data_parts = call.data.split(':')
    if len(data_parts) < 3: return
    panel_name = data_parts[2]
    
    # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡: Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù…Ø§Ú˜ÙˆÙ„ state
    state.admin_conversations[uid] = {
        'action': 'add_user',
        'step': 'get_name',
        'data': {
            'panel_name': panel_name,
            'telegram_id': None,
            'squad_uuid': None
        },
        'msg_id': msg_id,
        'timestamp': time.time(),
        'next_handler': get_new_user_name
    }
    
    safe_panel_name = escape_markdown(panel_name)
    text = (
        f"âœ… Ø³Ø±ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: *{safe_panel_name}*\n\n"
        f"ğŸ‘¤ Ù„Ø·ÙØ§Ù‹ *Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯* Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
    )
    
    kb = types.InlineKeyboardMarkup()
    kb.add(admin_menu.btn("Ø§Ù†ØµØ±Ø§Ù", "admin:cancel"))
    
    await _safe_edit(uid, msg_id, text, reply_markup=kb, parse_mode="MarkdownV2")

async def get_new_user_name(message: types.Message):
    """Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… â¬…ï¸ Ø±ÙØªÙ† Ø¨Ù‡ UUID"""
    uid, name = message.from_user.id, message.text.strip()
    await _delete_user_message(message)
    
    # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    if uid not in state.admin_conversations: return
    
    state.admin_conversations[uid]['data']['name'] = name
    
    await _ask_uuid(uid, name)

async def _ask_uuid(uid, name):
    """Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª UUID"""
    # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    state.admin_conversations[uid]['step'] = 'get_uuid'
    state.admin_conversations[uid]['next_handler'] = get_new_user_uuid
    
    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² try-except Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ (Ø·Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡ Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§)
    msg_id = state.admin_conversations[uid]['msg_id']
    text = (
        f"ğŸ‘¤ Ù†Ø§Ù…: `{escape_markdown(name)}`\n\n"
        f"ğŸ”‘ Ù„Ø·ÙØ§Ù‹ *UUID* Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n"
        f"\(ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø±Ù†Ø¯ÙˆÙ…ØŒ ÙÙ‚Ø· Ú©Ø§Ø±Ø§Ú©ØªØ± `.` Ø±Ø§ Ø¨ÙØ±Ø³ØªÛŒØ¯\)"
    )
    try:
        await bot.edit_message_text(
            text, 
            uid, 
            msg_id, 
            reply_markup=await admin_menu.cancel_action(),
            parse_mode="MarkdownV2"
        )
    except:
        pass

async def get_new_user_uuid(message: types.Message):
    """Ù…Ø±Ø­Ù„Ù‡ Û²: Ø¯Ø±ÛŒØ§ÙØª UUID Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø¬Ù…"""
    uid, text = message.from_user.id, message.text.strip()
    await _delete_user_message(message)
    
    if uid not in state.admin_conversations: return # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    
    final_uuid = None
    if text == '.' or text.lower() == 'random':
        final_uuid = str(uuid_lib.uuid4())
    elif validate_uuid(text):
        final_uuid = text
    else:
        msg_id = state.admin_conversations[uid]['msg_id'] # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
        try:
            await bot.edit_message_text(
                r"âŒ ÙØ±Ù…Øª UUID Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª\. Ù…Ø¬Ø¯Ø¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ `\.` Ø¨Ø²Ù†ÛŒØ¯:", 
                uid, msg_id, 
                reply_markup=await admin_menu.cancel_action(),
                parse_mode="MarkdownV2"
            )
        except: pass
        return

    state.admin_conversations[uid]['data']['uuid'] = final_uuid # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    await _ask_limit(uid)

async def _ask_limit(uid):
    """Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø¬Ù…"""
    state.admin_conversations[uid]['step'] = 'get_limit' # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    state.admin_conversations[uid]['next_handler'] = get_new_user_limit
    
    msg_id = state.admin_conversations[uid]['msg_id']
    try:
        await bot.edit_message_text(
            "ğŸ“¦ Ù„Ø·ÙØ§Ù‹ *Ø­Ø¬Ù… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª \(GB\)* Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\n\(Ø¹Ø¯Ø¯ 0 Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯\)", 
            uid, msg_id,
            reply_markup=await admin_menu.cancel_action(), 
            parse_mode="MarkdownV2"
        )
    except: pass

async def get_new_user_limit(message: types.Message):
    """Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¯Ø±ÛŒØ§ÙØª Ø­Ø¬Ù… â¬…ï¸ Ø±ÙØªÙ† Ø¨Ù‡ Ø²Ù…Ø§Ù†"""
    uid, text = message.from_user.id, message.text.strip()
    await _delete_user_message(message)
    if uid not in state.admin_conversations: return # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    
    msg_id = state.admin_conversations[uid]['msg_id']
    
    try:
        limit = float(text)
        state.admin_conversations[uid]['data']['limit'] = limit # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
        
        state.admin_conversations[uid]['step'] = 'get_days'
        state.admin_conversations[uid]['next_handler'] = get_new_user_days
        
        try:
            msg_text = "ğŸ“… Ù„Ø·ÙØ§Ù‹ *Ù…Ø¯Øª Ø§Ø¹ØªØ¨Ø§Ø±* Ø±Ø§ Ø¨Ù‡ Ø±ÙˆØ² ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
            await bot.edit_message_text(msg_text, uid, msg_id, reply_markup=await admin_menu.cancel_action())
        except: pass
        
    except ValueError:
        try:
            error_text = "âŒ Ù„Ø·ÙØ§Ù‹ *Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø±* ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\.\n\nğŸ“¦ Ù„Ø·ÙØ§Ù‹ Ø­Ø¬Ù… Ø±Ø§ Ø¨Ù‡ Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
            await bot.edit_message_text(error_text, uid, msg_id, reply_markup=await admin_menu.cancel_action(), parse_mode="MarkdownV2")
        except: pass

async def get_new_user_days(message: types.Message):
    """Ù…Ø±Ø­Ù„Ù‡ Û´: Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù† â¬…ï¸ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ"""
    uid, text = message.from_user.id, message.text.strip()
    await _delete_user_message(message)
    if uid not in state.admin_conversations: return # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    
    try:
        days = int(text)
        state.admin_conversations[uid]['data']['days'] = days # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
        
        panel_name = state.admin_conversations[uid]['data'].get('panel_name')
        is_remnawave = False
        
        if panel_name != 'all':
             p = await db.get_panel_by_name(panel_name)
             if p and p['panel_type'] == 'remnawave':
                 is_remnawave = True
        
        if is_remnawave:
            name = state.admin_conversations[uid]['data']['name']
            await _ask_telegram_id(uid, name)
        else:
            await _finalize_user_creation(uid)

    except ValueError:
        msg_id = state.admin_conversations[uid]['msg_id']
        try:
            error_text = "âŒ Ù„Ø·ÙØ§Ù‹ *Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø±* ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\.\n\nğŸ“… Ù„Ø·ÙØ§Ù‹ *Ù…Ø¯Øª Ø§Ø¹ØªØ¨Ø§Ø±* Ø±Ø§ Ø¨Ù‡ Ø±ÙˆØ² ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
            await bot.edit_message_text(error_text, uid, msg_id, reply_markup=await admin_menu.cancel_action(), parse_mode="MarkdownV2")
        except: pass

async def _ask_telegram_id(uid, name, prefix_msg=""):
    """Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø¢ÛŒØ¯ÛŒ"""
    state.admin_conversations[uid]['step'] = 'get_telegram_id' # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    state.admin_conversations[uid]['next_handler'] = get_new_user_telegram_id
    
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("Ø±Ø¯ Ú©Ø±Ø¯Ù† (Ø®Ø§Ù„ÛŒ)", callback_data="admin:skip_telegram_id"),
        admin_menu.btn("Ø§Ù†ØµØ±Ø§Ù", "admin:cancel")
    )

    safe_name = escape_markdown(name)
    safe_prefix = escape_markdown(prefix_msg) if prefix_msg else ""
    full_msg = f"{safe_prefix}\n\n" if safe_prefix else ""
    
    full_msg += (
        f"ğŸ‘¤ Ù†Ø§Ù…: `{safe_name}`\n\n"
        f"ğŸ†” Ù„Ø·ÙØ§Ù‹ *Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…* Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\n"
        f"\(Ø§Ø®ØªÛŒØ§Ø±ÛŒ \- Ø¬Ù‡Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ\)"
    )

    try:
        await bot.edit_message_text(full_msg, uid, state.admin_conversations[uid]['msg_id'], reply_markup=kb, parse_mode="MarkdownV2")
    except: pass

async def get_new_user_telegram_id(message: types.Message):
    """Ù…Ø±Ø­Ù„Ù‡ Ûµ (Ø±Ù…Ù†Ø§ÙˆÛŒÙˆ): Ø¯Ø±ÛŒØ§ÙØª ØªÙ„Ú¯Ø±Ø§Ù… Ø¢ÛŒØ¯ÛŒ"""
    uid, text = message.from_user.id, message.text.strip()
    await _delete_user_message(message)
    if uid not in state.admin_conversations: return # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    
    msg_id = state.admin_conversations[uid]['msg_id']

    if not text.isdigit():
        try:
            await bot.edit_message_text(
                "âŒ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…):", 
                uid, msg_id, 
                reply_markup=await admin_menu.cancel_action()
            )
        except: pass
        return

    state.admin_conversations[uid]['data']['telegram_id'] = text # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    await _ask_squad_selection(uid)

async def skip_telegram_id(call: types.CallbackQuery, params: list):
    """Ø±Ø¯ Ú©Ø±Ø¯Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ø¢ÛŒØ¯ÛŒ"""
    uid = call.from_user.id
    
    if uid in state.admin_conversations: # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
        state.admin_conversations[uid]['data']['telegram_id'] = None
        await _ask_squad_selection(uid)

async def _ask_squad_selection(uid):
    """Ù…Ø±Ø­Ù„Ù‡ Û¶ (Ø±Ù…Ù†Ø§ÙˆÛŒÙˆ): Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ø§Ø³Ú©ÙˆØ§Ø¯Ù‡Ø§"""
    msg_id = state.admin_conversations[uid]['msg_id'] # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    panel_name = state.admin_conversations[uid]['data'].get('panel_name')
    name = state.admin_conversations[uid]['data']['name']
    
    try:
        try:
            await bot.edit_message_text("â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ \(Squads\)\.\.\.", uid, msg_id, parse_mode="MarkdownV2")
        except: pass
        
        panel_api = await PanelFactory.get_panel(panel_name)
        squads = await panel_api.get_active_squads()

        if squads:
            kb = types.InlineKeyboardMarkup(row_width=2)
            squad_buttons = []
            for s in squads:
                squad_buttons.append(
                    types.InlineKeyboardButton(f"ğŸ›¡ {s['name']}", callback_data=f"admin:sel_squad:{s['uuid']}")
                )
            kb.add(*squad_buttons)
            kb.add(types.InlineKeyboardButton("Ø±Ø¯ Ú©Ø±Ø¯Ù† (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)", callback_data="admin:skip_squad"))
            kb.add(admin_menu.btn("Ø§Ù†ØµØ±Ø§Ù", "admin:cancel"))

            state.admin_conversations[uid]['step'] = 'get_squad' # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
            state.admin_conversations[uid]['next_handler'] = None 
            
            safe_name = escape_markdown(name)
            prompt_text = (
                f"ğŸ‘¤ Ù†Ø§Ù…: `{safe_name}`\n\n"
                f"ğŸ›¡ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© *Ú¯Ø±ÙˆÙ‡ \(Squad\)* Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n"
                f"\(ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯\)"
            )
            try:
                await bot.edit_message_text(prompt_text, uid, msg_id, reply_markup=kb, parse_mode="MarkdownV2")
            except: pass
        else:
            await _finalize_user_creation(uid)
            
    except Exception as e:
        logger.error(f"Error in squad selection: {e}")
        await _finalize_user_creation(uid)

async def handle_squad_callback(call: types.CallbackQuery, params: list):
    """Ø¯Ø±ÛŒØ§ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Ú©ÙˆØ§Ø¯ Ø¯Ø§Ø®Ù„ÛŒ"""
    uid = call.from_user.id
    if uid not in state.admin_conversations: return # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡

    action = call.data.split(':')[1]
    squad_uuid = None

    if action == 'sel_squad' and params:
        squad_uuid = params[0]
        try: await bot.answer_callback_query(call.id, "âœ… Ú¯Ø±ÙˆÙ‡ Ø¯Ø§Ø®Ù„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.")
        except: pass
    else:
        try: await bot.answer_callback_query(call.id, "â­ Ø±Ø¯ Ø´Ø¯.")
        except: pass

    state.admin_conversations[uid]['data']['squad_uuid'] = squad_uuid # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    await _ask_external_squad_selection(uid)

async def _ask_external_squad_selection(uid):
    """Ù…Ø±Ø­Ù„Ù‡ Û· (Ø±Ù…Ù†Ø§ÙˆÛŒÙˆ): Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª External Squads"""
    msg_id = state.admin_conversations[uid]['msg_id'] # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    panel_name = state.admin_conversations[uid]['data'].get('panel_name')
    
    try:
        try: await bot.edit_message_text("â³ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª External Squads...", uid, msg_id)
        except: pass
        
        panel_api = await PanelFactory.get_panel(panel_name)
        
        if not hasattr(panel_api, 'get_active_external_squads'):
            await _finalize_user_creation(uid)
            return

        ext_squads = await panel_api.get_active_external_squads()

        if ext_squads:
            kb = types.InlineKeyboardMarkup(row_width=2)
            buttons = []
            for s in ext_squads:
                buttons.append(
                    types.InlineKeyboardButton(f"ğŸŒ {s['name']}", callback_data=f"admin:sel_ext_squad:{s['uuid']}")
                )
            kb.add(*buttons)
            kb.add(admin_menu.btn("Ø§Ù†ØµØ±Ø§Ù", "admin:cancel"))

            state.admin_conversations[uid]['step'] = 'get_ext_squad' # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
            
            prompt_text = (
                "ğŸŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© *External Squad* Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n"
                "\(ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¸Ø§Ù‡Ø±ÛŒ Ùˆ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ø§Ø² Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯\)"
            )
            try: await bot.edit_message_text(prompt_text, uid, msg_id, reply_markup=kb, parse_mode="MarkdownV2")
            except: pass
        else:
            await _finalize_user_creation(uid)
            
    except Exception as e:
        logger.error(f"Error in external squad selection: {e}")
        await _finalize_user_creation(uid)

async def handle_external_squad_callback(call: types.CallbackQuery, params: list):
    """Ø¯Ø±ÛŒØ§ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Ú©ÙˆØ§Ø¯ Ø®Ø§Ø±Ø¬ÛŒ"""
    uid = call.from_user.id
    if uid not in state.admin_conversations: return # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡

    ext_uuid = params[0]
    try: await bot.answer_callback_query(call.id, "âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.")
    except: pass

    state.admin_conversations[uid]['data']['external_squad_uuid'] = ext_uuid # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    await _finalize_user_creation(uid)

async def _finalize_user_creation(uid):
    """Ù…Ø±Ø­Ù„Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±"""
    if uid not in state.admin_conversations: return # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    
    convo_data = state.admin_conversations.pop(uid) # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    data = convo_data['data']
    msg_id = convo_data['msg_id']
    
    def safe_code(text):
        return f"`{str(text).replace('`', '')}`"

    try: await bot.edit_message_text("â³ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±\.\.\.", uid, msg_id, parse_mode="MarkdownV2")
    except: pass

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    panel_name_target = data['panel_name']
    name = data['name']
    limit = data['limit']
    days = data.get('days', 30)
    user_uuid = data.get('uuid')
    telegram_id = data.get('telegram_id')
    squad_uuid = data.get('squad_uuid')
    external_squad_uuid = data.get('external_squad_uuid')

    success_list = []
    fail_list = []
    
    target_panels = []
    if panel_name_target == 'all':
        target_panels = await db.get_active_panels()
    else:
        p = await db.get_panel_by_name(panel_name_target)
        if p: target_panels = [p]

    if not target_panels:
         try: await bot.edit_message_text("âŒ Ù¾Ù†Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.", uid, msg_id, reply_markup=await admin_menu.main())
         except: pass
         return

    for p in target_panels:
        try:
            panel_api = await PanelFactory.get_panel(p['name'])
            res = await panel_api.add_user(
                name, limit, days, 
                uuid=user_uuid, 
                telegram_id=telegram_id, 
                squad_uuid=squad_uuid,
                external_squad_uuid=external_squad_uuid
            )
            
            if res and res.get('uuid') and not user_uuid:
                user_uuid = res.get('uuid')

            display_str = f"{escape_markdown(p['name'])} \({escape_markdown(p['panel_type'])}\)"
            
            if res: success_list.append(display_str)
            else: fail_list.append(display_str)

        except Exception as e:
            logger.error(f"Error creating user: {e}")
            fail_list.append(escape_markdown(p['name']))

    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data=f"admin:management_menu"))

    if success_list:
        success_str = "\n".join([f"ğŸŸ¢ {s}" for s in success_list])
        if not user_uuid: user_uuid = "Ù†Ø§Ù…Ø´Ø®Øµ"
        
        limit_val = int(limit) if limit == int(limit) else limit
        limit_display = f"{limit_val}\u00A0GB"
        days_display = f"{days}\u00A0Ø±ÙˆØ²"
        
        result_text = (
            f"âœ… *{escape_markdown('Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª')}*\n\n"
            f"ğŸ‘¤ {escape_markdown('Ù†Ø§Ù…')} : {safe_code(name)}\n"
            f"ğŸ”‘ {escape_markdown('Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§')} : {safe_code(user_uuid)}\n"
            f"ğŸ“¦ {escape_markdown('Ø­Ø¬Ù…')} : {safe_code(limit_display)} \| ğŸ“… {escape_markdown('Ù…Ø¯Øª')} : {safe_code(days_display)}\n\n"
            f"ğŸ‘‡ {escape_markdown('Ù…ÙˆÙÙ‚ Ø¯Ø±')}:\n{success_str}\n"
        )
        
        if fail_list:
            fail_str = "\n".join([f"ğŸ”´ {s}" for s in fail_list])
            result_text += f"\n{escape_markdown('Ù†Ø§Ù…ÙˆÙÙ‚ Ø¯Ø±')}:\n{fail_str}"
            
        try: await bot.edit_message_text(result_text, uid, msg_id, reply_markup=kb, parse_mode="MarkdownV2")
        except: pass
    else:
        try: await bot.edit_message_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±.", uid, msg_id, reply_markup=kb)
        except: pass

async def handle_cancel_process(call: types.CallbackQuery, params: list):
    """Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª"""
    uid = call.from_user.id
    if uid in state.admin_conversations: # âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
        del state.admin_conversations[uid]
    
    try: await bot.answer_callback_query(call.id, "âŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
    except: pass
    try:
        active_panels = await db.get_active_panels()
        await _safe_edit(uid, call.message.message_id, "Ù…Ù†ÙˆÛŒ Ù…Ø¯ÛŒØ±ÛŒØª:", reply_markup=await admin_menu.management_menu(active_panels))
    except: pass

async def handle_start_add_user(call: types.CallbackQuery, params: list):
    await handle_add_user_select_panel(call)